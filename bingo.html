<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#ffffff">
	<meta http-equiv="cache-control" content="max-age=0" />
	<meta http-equiv="cache-control" content="no-cache" />
	<meta http-equiv="expires" content="0" />
	<meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
	<meta http-equiv="pragma" content="no-cache" />
    <link rel="manifest" href="manifest.json">
	<link rel="icon" type="image/x-icon" href="bingo-icon.png">
	<link rel="apple-touch-icon" href="bingo-icon.png">
    <title i18nId="ATEN Bingo Card">ATEN Bingo Card Generator</title>
    <style>
		:root {
		  /* Material Design 3 è‰²å½© */
		  --md-sys-primary: #6750A4;
		  --md-sys-on-primary: #FFFFFF;
		  --md-sys-primary-container: #EADDFF;
		  --md-sys-on-primary-container: #21005D;

		  --md-sys-secondary-container: #F3EFFF;
		  --md-sys-on-secondary-container: #311F75;

		  --md-sys-tertiary: #7D5260;
		  --md-sys-on-tertiary: #FFFFFF;

		  --md-sys-surface: #FFFFFF;
		  --md-sys-on-surface: #1C1B1F;

		  /* Material Elevation */
		  --md-sys-elevation1: 0 1px 3px rgba(0, 0, 0, 0.2);
		  --md-sys-elevation2: 0 2px 6px rgba(0, 0, 0, 0.15);
		  --md-sys-elevation3: 0 3px 8px rgba(0, 0, 0, 0.12);
		  --md-sys-elevation4: 0 4px 10px rgba(0, 0, 0, 0.1);
		}
        body {
            font-family: 'Roboto', sans-serif;
            text-align: center;
            margin: 0;
            padding: 0;
        }
        .bingo-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin: 20px;
        }
        .bingo-card {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            border: 2px solid #000;
			border-radius: 8px;
            padding: 10px;
            position: relative;
			box-shadow: var(--md-sys-elevation1);
			color: var(--md-sys-on-surface);
        }
		.bingo-card.three-lines {
			background-color: #ffffe0; /* light yellow */
		}
		.bingo-card.five-lines {
			background-color: #d0f0c0; /* light-green */
		}
        .remove-button {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: red;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            width: 20px;
            height: 20px;
        }
        .remove-button:hover {
            background-color: darkred;
        }
        .card-header {
            grid-column: span 5;
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .cell {
            border: 1px solid #000;
            padding: 4px;
            text-align: center;
            font-size: 40px;
			width: 56px;
            background-color: #f9f9f9;
			font-weight: bold;
			color: var(--md-sys-on-primary-container);
			border-radius: 8px;
			box-shadow: var(--md-sys-elevation2);
			cursor: pointer;
			transition: all 0.3s ease;
        }
		.cell:focus {
			outline: none;
			box-shadow: var(--md-sys-elevation4);
			transform: scale(1.1);
		}
		.cell:hover {
			color: var(--md-sys-elevation3);
		}
		.cell.selected {
			background: var(--md-sys-tertiary);
			color: var(--md-sys-on-tertiary);
			box-shadow: var(--md-sys-elevation3);
		}
        .matched {
            background-color: #90ee90;
        }
        .duplicate {
            background-color: #ffcccb;
        }
        .line-count {
            position: absolute;
            top: 5px;
            right: 10px;
            background-color: #fff;
            padding: 5px;
            border: 1px solid #000;
            font-size: 14px;
        }
        .history {
            margin-top: 20px;
            text-align: left;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
			padding: 0 20px;
        }
        .input-section {
            margin-top: 10px;
			position: relative;
			display: inline-block;
        }
        .fixed-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #eee;
            color: white;
            padding: 10px 0;
            text-align: center;
            z-index: 1000;
        }
        .content {
            margin-top: 80px; 
        }
		.input-section button, .input-section input {
			font-size: 24px;
		}
		.input-section button {
			padding: 4px 8px;
			margin: 4px;
			cursor: pointer;
			border-radius: 4px;
			background-color: #6200ea;
			color: #ffffff;
			border: none;
		}
		.input-section button:hover {
			background-color: #3700b3;
		}
		#input-number {
			max-width: 8rem;
		}
		.input-section input {
			padding-left: 40px;
			border: 2px solid #ccc;
			border-radius: 5px;
			width: 100px;
			outline: none;
			transition: border-color 0.3s, box-shadow 0.3s;
		}
		.input-section input:focus {
			border-color: #6200ea;
			box-shadow: 0 0 5px rgba(98, 0, 234, 0.5);
		}
		.input-section label {
			position: absolute;
			top: 50%;
			left: 10px;
			transform: translateY(-50%);
			font-size: 14px;
			color: #aaa;
			pointer-events: none;
			transition: all 0.2s ease;
		}
		.input-section input:focus + label,
		.input-section input:not(:placeholder-shown) + label {
			top: -10px;
			font-size: 12px;
			color: #6200ea;
		}
		.input-section input::placeholder {
			color: #aaa;
			font-style: italic;
		}
		.input-section .icon {
			position: absolute;
			top: 50%;
			left: 5px;
			transform: translateY(-50%);
			color: #6200ea;
			font-size: 20px;
			pointer-events: none;
		}
		.message-box {
			margin-top: 20px;
		}
		.md3-text-field {
		  position: relative;
		  margin: 16px;
		  display: inline-block;
		}

		.md3-text-field input {
		  font-size: 24px;
		  padding: 8px 12px 8px 36px;
		  border: 2px solid #ccc;
		  border-radius: 4px;
		  outline: none;
		  transition: border-color 0.3s, box-shadow 0.3s;
		  width: 200px;
		}

		.md3-text-field input:focus {
		  border-color: #6200ea;
		  box-shadow: 0 0 5px rgba(98, 0, 234, 0.5);
		}

		.md3-text-field label {
		  position: absolute;
		  top: 50%;
		  left: 40px;
		  transform: translateY(-50%);
		  font-size: 16px;
		  color: #aaa;
		  pointer-events: none;
		  transition: all 0.2s ease;
		  background: white;
		  padding: 0 4px;
		}

		.md3-text-field input:focus + label,
		.md3-text-field input:not(:placeholder-shown) + label {
		  top: -10px;
		  font-size: 12px;
		  color: #6200ea;
		}

		.md3-outline {
		  position: absolute;
		  inset: 0;
		  border: 2px solid #ccc;
		  border-radius: 4px;
		  pointer-events: none;
		  z-index: -1;
		  transition: border-color 0.3s ease;
		}

		.md3-text-field input:focus ~ .md3-outline {
		  border-color: #6200ea;
		}
    </style>
	
</head>
<body>
    <h1>Bingo Card Generator</h1>
	<div class="fixed-header">
		<div class="input-section">
			<button onclick="addRandomBingoCard()">+Random</button>
			<button onclick="addCustomBingoCard()">+Custom</button>
			<button onclick="sortHistory()">Sort</button>
			<!-- <button onclick="matchHistoryNumber()">Recheck Bingo Card</button> -->
		</div>
		<div class="input-section md3-text-field">
			<span class="icon">ðŸ”¢</span>
			<input type="number" id="input-number" min="1" max="70" size="2" placeholder=" " required>
			<label for="input-number">Number 1-70</label>
			<button onclick="markNumber()">Check</button>
			<div class="md3-outline"></div>
		</div>
	</div>
	<div class="content">
		<div class="message-box" id="message-box"></div>
		<div class="history" id="history"></div>
		<div class="bingo-container" id="bingo-container"></div>
	</div>
	<script src="umd.js"></script>
    <script>
        // Open IndexedDB
        const dbPromise = idb.openDB('bingo-pwa-db', 1, {
            upgrade(db) {
                if (!db.objectStoreNames.contains('matchHistory')) {
                    db.createObjectStore('matchHistory', { keyPath: 'id', autoIncrement: true });
                }
                if (!db.objectStoreNames.contains('allCardNumbers')) {
                    db.createObjectStore('allCardNumbers', { keyPath: 'id', autoIncrement: true });
                }
            },
        });

        function saveMatchHistory() {
            dbPromise.then((db) => {
                const tx = db.transaction('matchHistory', 'readwrite');
                const store = tx.objectStore('matchHistory');
                store.put({ id: 1, data: matchHistory });
                return tx.complete;
            });
        }

        function loadMatchHistory() {
            dbPromise.then((db) => {
                const tx = db.transaction('matchHistory', 'readonly');
                const store = tx.objectStore('matchHistory');
                return store.get(1);
            }).then((record) => {
                if (record && record.data) {
                    matchHistory = record.data;
                    updateHistory();
                    matchHistoryNumber();
                }
            });
        }

        function saveAllCardNumbers() {
			updateAllCardNumbers();
            dbPromise.then((db) => {
                const tx = db.transaction('allCardNumbers', 'readwrite');
                const store = tx.objectStore('allCardNumbers');
                store.put({ id: 1, data: allCardNumbers });
                return tx.complete;
            });
        }

        function loadAllCardNumbers() {
            dbPromise.then((db) => {
                const tx = db.transaction('allCardNumbers', 'readonly');
                const store = tx.objectStore('allCardNumbers');
                return store.get(1);
            }).then((record) => {
                if (record && record.data) {
                    allCardNumbers = record.data;
					allCardNumbers.forEach(cardNumber => {
						cardCount++;
						const card = createBingoCard(cardCount, cardNumber);
						document.getElementById('bingo-container').appendChild(card);
					});
                    matchHistoryNumber();
                }
            });
        }
		
        let cardCount = 0;
		let allCardNumbers = [];
        let matchHistory = [];

        function addRandomBingoCard() {
            cardCount++;
            const card = createBingoCard(cardCount, generateUniqueNumbers(25, 1, 70));
            document.getElementById('bingo-container').appendChild(card);
			matchHistoryNumber();
			saveAllCardNumbers();
        }

        function addCustomBingoCard() {
            cardCount++;
            const card = createBingoCard(cardCount);
            document.getElementById('bingo-container').appendChild(card);
			matchHistoryNumber();
			saveAllCardNumbers();
        }

        function createBingoCard(cardNumber, numbers = []) {
            const card = document.createElement('div');
            card.classList.add('bingo-card');

            const removeButton = document.createElement('button');
            removeButton.classList.add('remove-button');
            removeButton.textContent = 'X';
            removeButton.onclick = () => removeCard(card);
            card.appendChild(removeButton);

            const header = document.createElement('div');
            header.classList.add('card-header');
            header.textContent = `Card #${cardNumber}`;
            card.appendChild(header);

            for (let i = 0; i < 25; i++) {
                const cell = document.createElement('div');
                cell.classList.add('cell');
                cell.contentEditable = true;
                if (numbers[i]) {
                    cell.textContent = numbers[i];
                    cell.dataset.number = numbers[i];
                }
				
                cell.addEventListener('input', (event) => {
                    const value = parseInt(cell.textContent);
                    if (!isNaN(value) && value >= 1 && value <= 70) {
                        cell.dataset.number = value;
                        validateDuplicates(card);
                    } else {
                        cell.dataset.number = '';
                        cell.textContent = ''; // Clear invalid input
                        validateDuplicates(card);
                    }

                    // Re-check bingo and lines whenever the card changes
					saveAllCardNumbers();
                    checkLines();
                });

				cell.addEventListener('click', () => {
					//cell.classList.toggle('selected');
					const input = document.getElementById('input-number');
					input.value = cell.textContent;
					markNumber();
				});

                cell.addEventListener('dblclick', () => {
                    cell.textContent = '';
                    cell.dataset.number = '';
                    cell.classList.remove('matched');
                    validateDuplicates(card);
					saveAllCardNumbers();
                    checkLines();
                });
                card.appendChild(cell);
            }

            const lineCount = document.createElement('div');
            lineCount.classList.add('line-count');
            lineCount.textContent = 'Lines: 0';
            card.appendChild(lineCount);

            return card;
        }

        function generateUniqueNumbers(count, min, max) {
            const numbers = new Set();
            while (numbers.size < count) {
                numbers.add(Math.floor(Math.random() * (max - min + 1)) + min);
            }
            return Array.from(numbers);
        }

        function removeCard(card) {
            card.remove();
			saveAllCardNumbers();
        }

        function validateDuplicates(card) {
            const cells = card.querySelectorAll('.cell');
            const seenNumbers = new Set();

            cells.forEach(cell => cell.classList.remove('duplicate'));

            cells.forEach(cell => {
                const number = cell.dataset.number;
                if (number && seenNumbers.has(number)) {
                    cell.classList.add('duplicate');
                } else if (number) {
                    seenNumbers.add(number);
                }
            });
        }

		function sortHistory() {
			matchHistory.sort((a, b) => a - b); // sort small to big
			updateHistory(); 
			saveMatchHistory();
		}

        function markNumber() {
            const input = document.getElementById('input-number');
            const number = parseInt(input.value);
			updateMessage("");

            if (isNaN(number) || number < 1 || number > 70) {
                alert('Please enter a valid number between 1 and 70.');
                return;
            }

			let hisMatched = false;
			if (matchHistory.includes(number)) {
				matchHistory = matchHistory.filter(num => num !== number);
				hisMatched = true;
			} else {
				matchHistory.push(number);
			}
			saveMatchHistory(); // save update
			
            const cells = document.querySelectorAll('.cell');
			
			let numMatched = false;
			let countMatched = 0;
            cells.forEach(cell => {
                if (cell.dataset.number == number) {
					if (hisMatched){
					// Remove the mark if it's a duplicate
                        cell.classList.remove('matched');
					} else {
						cell.classList.add('matched');
						countMatched++;
					}
					numMatched = true;
                }
            });

			updateHistory();
            if (numMatched) {
                checkLines();
				if (hisMatched){
					updateMessage(`Number ${number} Remove ${countMatched} times in Cards`);
				} else {
					updateMessage(`Number ${number} Match ${countMatched} times in Cards`);
				}
				
            }else{
				updateMessage(`Number ${number} Not Match in Cards`)
			}

            input.value = '';
        }

		function matchHistoryNumber() {
			const cells = document.querySelectorAll('.cell');
			cells.forEach(cell => {
				if (matchHistory.includes(parseInt(cell.dataset.number))) {
					cell.classList.add('matched');
				} else {
					// Remove the mark if it's a duplicate
					cell.classList.remove('matched');
				}
			});
			checkLines();
		}

        function checkLines() {
            const cards = document.querySelectorAll('.bingo-card');
            cards.forEach(card => {
                const cells = card.querySelectorAll('.cell');
                const grid = Array.from(cells).map(cell => cell.classList.contains('matched'));

                let lines = 0;

                // Check rows
                for (let i = 0; i < 5; i++) {
                    if (grid.slice(i * 5, i * 5 + 5).every(matched => matched)) {
                        lines++;
                    }
                }

                // Check columns
                for (let i = 0; i < 5; i++) {
                    if ([0, 1, 2, 3, 4].every(j => grid[i + j * 5])) {
                        lines++;
                    }
                }

                // Check diagonals
                if ([0, 6, 12, 18, 24].every(i => grid[i])) {
                    lines++;
                }
                if ([4, 8, 12, 16, 20].every(i => grid[i])) {
                    lines++;
                }

                const lineCount = card.querySelector('.line-count');
				const cardHeader = card.querySelector('.card-header');
                lineCount.textContent = `Lines: ${lines}`;
				
				// Update card background based on line count
				if (lines >= 5) {
					card.classList.add('five-lines');
					card.classList.remove('three-lines');
					updateMessage(`Match ${lines}`);
				} else if (lines >= 3) {
					card.classList.add('three-lines');
					card.classList.remove('five-lines');
					updateMessage(`Match ${lines}`);
				} else {
					card.classList.remove('three-lines', 'five-lines');
				}
            });
        }
		
		function updateAllCardNumbers() {
			const bingoCards = document.querySelectorAll('.bingo-card');

			allCardNumbers = Array.from(bingoCards).map(card => {
			  const cells = card.querySelectorAll('.cell');
			  return Array.from(cells).map(cell => parseInt(cell.dataset.number, 10));
			});

		}
		
        function updateHistory() {
            const historyDiv = document.getElementById('history');
		if (matchHistory.length === 0) {
			historyDiv.innerHTML = `<h2>Compare</h2><p>No numbers yet.</p>`;
		} else {
			historyDiv.innerHTML = `<h2>Compare</h2><p>${matchHistory.join(', ')}</p>`;
		}
			historyDiv.innerHTML = `<h2>Compare</h2><p>${matchHistory.join(', ')}</p>`;
        }
		
		function updateMessage(msg) {
            const historyDiv = document.getElementById('message-box');
			historyDiv.innerHTML = `<p>${msg}</p>`;
		}

		if ('serviceWorker' in navigator) {
			navigator.serviceWorker
				.register('service-worker.js')
				.then(() => console.log('Service Worker Registered'))
				.catch((err) => console.error("Service Worker Registration Failed:", err));
		}
	
        // Initial Match History Data
        window.onload = () => {
			loadAllCardNumbers();
            loadMatchHistory();
        };
		
		// trigger Enter key
		document.getElementById('input-number').addEventListener('keydown', function (event) {
			if (event.key === 'Enter') {
				document.querySelector('button[onclick="markNumber()"]').click();
			}
		});
	</script>
</body>
</html>
